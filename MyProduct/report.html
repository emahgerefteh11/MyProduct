<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Cloud Cost Atlas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg:
        radial-gradient(1200px 600px at 10% -10%, rgba(136, 240, 255, 0.12), transparent 55%),
        radial-gradient(900px 500px at 90% 0%, rgba(255, 200, 87, 0.08), transparent 50%),
        linear-gradient(180deg, #0b1021 0%, #0f1a2e 100%);
      --panel: rgba(15, 23, 42, 0.55);
      --panel-strong: rgba(15, 23, 42, 0.75);
      --card: rgba(15, 23, 42, 0.5);
      --text: #e8edf8;
      --muted: #a3b0c7;
      --accent: #8fe9ff;
      --accent-2: #f2c97a;
      --accent-3: #8de9a7;
      --danger: #ff6b6b;
      --border: rgba(148, 163, 184, 0.18);
      --border-strong: rgba(148, 163, 184, 0.28);
      --shadow: 0 10px 30px rgba(2, 6, 23, 0.25);
      --radius: 12px;
      --chart-panel: rgba(11, 18, 32, 0.6);
      --chart-glow: rgba(143, 233, 255, 0.14);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'DM Sans', 'Space Grotesk', sans-serif;
      color: var(--text);
      background: var(--bg);
      min-height: 100vh;
      padding: 24px 28px 72px;
      line-height: 1.5;
    }
    .page { max-width: 1160px; margin: 0 auto; }
    header { display: flex; align-items: center; justify-content: space-between; gap: 16px; margin-bottom: 22px; }
    .title { font-family: 'Space Grotesk', 'DM Sans', sans-serif; font-size: 26px; letter-spacing: 0.4px; font-weight: 700; }
    .pill {
      background: rgba(15, 23, 42, 0.4);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 8px 14px;
      color: var(--muted);
      font-size: 12px;
      letter-spacing: 0.4px;
      text-transform: uppercase;
    }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 18px; margin-bottom: 22px; }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 18px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(6px);
    }
    .card h3 { margin: 0 0 10px; font-size: 15px; letter-spacing: 0.3px; color: #d9e2f3; }
    .big { font-size: 24px; font-weight: 700; letter-spacing: 0.3px; }
    .muted { color: var(--muted); }
    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; padding: 10px 0; font-size: 14px; }
    th { color: var(--muted); font-weight: 500; border-bottom: 1px solid var(--border); }
    tbody tr + tr td { border-top: 1px solid var(--border); }
    .bar { height: 6px; background: rgba(148, 163, 184, 0.22); border-radius: 999px; overflow: hidden; }
    .bar span { display: block; height: 100%; border-radius: 999px; background: linear-gradient(90deg, var(--accent), #6de2ff); }
    .chips { display: flex; flex-wrap: wrap; gap: 8px; }
    .chip { background: var(--panel); border: 1px solid var(--border); border-radius: 999px; padding: 4px 10px; font-size: 11px; color: var(--muted); }
    .stack-card { padding: 12px; background: var(--panel-strong); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: none; }
    .row { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    .tag { background: var(--panel); border: 1px solid var(--border); padding: 4px 8px; border-radius: 8px; font-size: 12px; color: var(--accent-2); }
    .tabs { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 14px; }
    .tab {
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.35);
      color: var(--muted);
      cursor: pointer;
      transition: all 0.15s ease;
      font-size: 13px;
      letter-spacing: 0.2px;
    }
    .tab.active {
      border-color: rgba(143, 233, 255, 0.6);
      background: rgba(15, 23, 42, 0.7);
      color: var(--text);
      box-shadow: none;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .filter-row { display: flex; gap: 12px; flex-wrap: wrap; }
    .select {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border-strong);
      background: rgba(11, 18, 32, 0.6);
      color: var(--text);
      min-width: 200px;
      font-family: inherit;
    }
    .select:focus { outline: 2px solid rgba(143, 233, 255, 0.35); outline-offset: 1px; }
    .chart-card { overflow: hidden; }
    .chart-shell {
      position: relative;
      padding: 12px;
      border-radius: 14px;
      background: var(--chart-panel);
      border: 1px solid var(--border-strong);
      box-shadow: inset 0 0 0 1px rgba(2, 6, 23, 0.4);
      margin-bottom: 12px;
    }
    .chart-shell::before {
      content: "";
      position: absolute;
      inset: 0;
      background:
        radial-gradient(380px 120px at 10% 0%, rgba(143, 233, 255, 0.22), transparent 60%),
        radial-gradient(320px 140px at 90% 0%, rgba(242, 201, 122, 0.18), transparent 65%);
      opacity: 0.6;
      pointer-events: none;
    }
    .chart-shell > * { position: relative; z-index: 1; }
    @media (max-width: 720px) { header { flex-direction: column; align-items: flex-start; } body { padding: 18px 18px 60px; } }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div>
        <div class="pill">FinOps Product Footprints</div>
        <div class="title">Cloud Cost Atlas</div>
      </div>
      <div class="pill" id="source-info">Loading...</div>
    </header>

    <div class="card" id="report-selector-card" style="margin-bottom:14px;">
      <div class="row" style="align-items:center;">
        <div>
          <h3 style="margin-bottom:4px;">Report</h3>
          <div class="muted">View aggregate or a single CUR file</div>
        </div>
        <select id="report-select" class="select"></select>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="finops">FinOps Overview</div>
      <div class="tab" data-tab="naming">Resource Naming & Platform</div>
      <div class="tab" data-tab="anomaly">Anomalies & Distributions</div>
    </div>

    <div id="finops" class="tab-content active">
      <div class="card" style="margin-bottom:14px;">
        <h3>Filters</h3>
        <div class="muted" style="margin-bottom:6px;">Choose platform and product (platform must be set for product filtering)</div>
        <div class="filter-row">
          <select id="finops-platform-filter" class="select"></select>
          <select id="finops-product-filter" class="select"></select>
        </div>
      </div>

      <div class="grid" id="metrics">
        <div class="card">
          <h3>Total Unblended Cost</h3>
          <div class="big" id="total-cost">--</div>
          <div class="muted" id="product-count"></div>
        </div>
        <div class="card">
          <h3>Storage Share (EBS + S3)</h3>
          <div class="big" id="storage-share">--</div>
          <div class="muted">Primary optimization surface</div>
        </div>
        <div class="card">
          <h3>Environments</h3>
          <div class="big" id="env-split">--</div>
          <div class="muted">dev / prod / staging</div>
        </div>
      </div>

      <div class="grid">
        <div class="card">
          <h3>Products by Cost</h3>
          <table id="products-table"><thead><tr><th>Product</th><th>Cost</th><th>Share</th></tr></thead><tbody></tbody></table>
        </div>
        <div class="card">
          <h3>Service Families by Cost</h3>
          <table id="services-table"><thead><tr><th>Service</th><th>Cost</th><th>Share</th></tr></thead><tbody></tbody></table>
        </div>
      </div>

      <div class="grid">
        <div class="card">
          <h3>Environments</h3>
          <table id="env-table"><thead><tr><th>Environment</th><th>Cost</th><th>Share</th></tr></thead><tbody></tbody></table>
        </div>
        <div class="card">
          <h3>Service Family Co-occurrence</h3>
          <div class="muted" style="margin-bottom:6px;">Pairs appearing together across products</div>
          <div id="co-table"></div>
        </div>
      </div>

      <div class="card">
        <h3>Product Stack Cards</h3>
        <div class="grid" id="stack-cards"></div>
      </div>

      <div class="card">
        <h3>Shared Service Stacks</h3>
        <div id="shared-stacks"></div>
      </div>
    </div>

    <div id="anomaly" class="tab-content">
      <div class="card" style="margin-bottom:14px;">
        <h3>Filters</h3>
        <div class="muted" style="margin-bottom:6px;">Choose platform and product</div>
        <div class="filter-row">
          <select id="anomaly-platform-filter" class="select"></select>
          <select id="anomaly-product-filter" class="select"></select>
        </div>
      </div>

      <div class="card chart-card">
        <h3>VM SKU Distribution</h3>
        <div class="muted" style="margin-bottom:6px;">Hours and instance counts across providers</div>
        <div class="chart-shell">
          <div id="anomaly-ec2-chart" style="height:320px;"></div>
        </div>
        <table id="anomaly-ec2-table"><thead><tr><th>Size</th><th>vCPU</th><th>RAM (GiB)</th><th>Hours</th><th>Instances</th></tr></thead><tbody></tbody></table>
      </div>

      <div class="card chart-card">
        <h3>Block Storage Size Buckets (GB / GB-Mo)</h3>
        <div class="chart-shell">
          <div id="anomaly-ebs-chart" style="height:260px;"></div>
        </div>
        <table id="anomaly-ebs-table"><thead><tr><th>Bucket</th><th>GB</th><th>Resources</th></tr></thead><tbody></tbody></table>
      </div>
      <div class="card chart-card">
        <h3>Object Storage Size Buckets (GB / GB-Mo)</h3>
        <div class="chart-shell">
          <div id="anomaly-s3-chart" style="height:260px;"></div>
        </div>
        <table id="anomaly-s3-table"><thead><tr><th>Bucket</th><th>GB</th><th>Resources</th></tr></thead><tbody></tbody></table>
      </div>
    </div>

    <div id="naming" class="tab-content">
      <div class="card" style="margin-bottom:14px;">
        <h3>Filters</h3>
        <div class="muted" style="margin-bottom:6px;">Choose platform and product (product filter applies within chosen platform)</div>
        <div class="filter-row">
          <select id="platform-filter" class="select"></select>
          <select id="naming-product-filter" class="select"></select>
        </div>
      </div>

      <div class="grid">
        <div class="card">
          <h3>Naming Convention</h3>
          <div class="muted" id="naming-meta" style="margin-bottom:8px;"></div>
          <div class="chips" id="naming-pattern"></div>
        </div>
        <div class="card">
          <h3>Providers</h3>
          <table id="providers-table"><thead><tr><th>Provider</th><th>Cost</th><th>Share</th><th>Rows</th></tr></thead><tbody></tbody></table>
        </div>
      </div>

      <div class="grid">
        <div class="card">
          <h3>Platform Totals</h3>
          <div class="muted" id="platform-meta"></div>
          <div style="margin-top:10px; display:grid; grid-template-columns: repeat(auto-fit,minmax(160px,1fr)); gap:10px;">
            <div class="stack-card"><div class="muted">Total Cost</div><div class="big" id="plat-cost">--</div></div>
            <div class="stack-card"><div class="muted">vCPU</div><div class="big" id="plat-vcpu">--</div></div>
            <div class="stack-card"><div class="muted">RAM (GiB)</div><div class="big" id="plat-ram">--</div></div>
            <div class="stack-card"><div class="muted">EBS (GB-Mo)</div><div class="big" id="plat-ebs">--</div></div>
            <div class="stack-card"><div class="muted">S3 (GB-Mo)</div><div class="big" id="plat-s3">--</div></div>
            <div class="stack-card"><div class="muted">NICs (approx)</div><div class="big" id="plat-nics">--</div></div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Resource Naming Breakdown</h3>
        <div class="muted" style="margin-bottom:6px;">Cost grouped by resource name segments</div>
        <table id="resnames-table"><thead><tr><th>Name prefix</th><th>Cost</th><th>Share</th><th>Rows</th></tr></thead><tbody></tbody></table>
      </div>

      <div class="card">
        <h3>Platforms</h3>
        <div class="muted" style="margin-bottom:6px;">Cost and count by platform (derived from resource names)</div>
        <table id="platforms-table"><thead><tr><th>Platform</th><th>Cost</th><th>Share</th><th>Rows</th></tr></thead><tbody></tbody></table>
      </div>

      <div class="card">
        <h3>EC2 SKUs</h3>
        <div class="muted" style="margin-bottom:6px;">Instance types for selected platform/product</div>
        <table id="ec2-table"><thead><tr><th>SKU</th><th>vCPU</th><th>RAM (GiB)</th><th>Hours</th><th>Instances</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
  </div>

  <script>
    // Plotly for charts
  </script>
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <script>
    const fmtMoney = (n) => `$${n.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
    const fmtPct = (n) => `${n.toFixed(2)}%`;
    const bucketOrder = ['0-100','100-500','500-1k','1k-5k','5k-10k','10k+'];
    const chartPalette = {
      vm: '#7dd3fc',
      block: '#f6c46a',
      object: '#6ee7b7'
    };

    async function loadData() {
      const res = await fetch('report_data.json').catch(() => fetch('MyProduct/report_data.json'));
      if (!res.ok) throw new Error('Cannot load report_data.json');
      return res.json();
    }

    function renderBars(rows, tbody) {
      tbody.innerHTML = '';
      rows.forEach((row) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${row.name}</td><td>${row.cost}</td><td><div class="bar"><span style="width:${Math.min(row.pct,100)}%"></span></div><div class="muted">${fmtPct(row.pct)}</div></td>`;
        tbody.appendChild(tr);
      });
    }

    function render() {
      loadData().then((data) => {
        const namingConfig = data.namingConvention || {};
        const reportCard = document.getElementById('report-selector-card');
        const reportSelect = document.getElementById('report-select');
        const reportViews = [];
        const reports = Array.isArray(data.reports) ? data.reports : [];

        if (reports.length > 1) {
          reportViews.push({ id: 'aggregate', label: 'All reports', data });
          reports.forEach((report, index) => {
            const summary = report.summary || report.data || report;
            reportViews.push({
              id: report.id || `report-${index + 1}`,
              label: report.label || `Report ${index + 1}`,
              data: summary
            });
          });
        } else if (reports.length === 1) {
          const report = reports[0];
          const summary = report.summary || report.data || report;
          reportViews.push({
            id: report.id || 'report-1',
            label: report.label || 'Report',
            data: summary
          });
        } else {
          reportViews.push({ id: 'report', label: data.reportLabel || 'Report', data });
        }

        let activeReport = reportViews[0];
        let activeData = activeReport.data;

        function updateSourceInfo() {
          const sourceInfo = document.getElementById('source-info');
          if (!sourceInfo) return;
          const label = activeReport ? activeReport.label : 'Report';
          sourceInfo.textContent = `Source: report_data.json / view: ${label}`;
        }

        function safeArray(value) {
          return Array.isArray(value) ? value : [];
        }

        function renderNamingMeta() {
          const namingMeta = document.getElementById('naming-meta');
          const namingPattern = document.getElementById('naming-pattern');
          if (!namingMeta || !namingPattern) return;
          const source = namingConfig.source || 'naming';
          const delimiter = namingConfig.delimiter || '-';
          const mode = namingConfig.mode ? ` / mode: ${namingConfig.mode}` : '';
          namingMeta.textContent = `Source: ${source} / delimiter: "${delimiter}"${mode}`;
          namingPattern.innerHTML = '';
          (namingConfig.pattern || []).forEach((token) => {
            const chip = document.createElement('div');
            chip.className = 'chip';
            chip.textContent = token;
            namingPattern.appendChild(chip);
          });
          if (!namingConfig.pattern || !namingConfig.pattern.length) {
            namingPattern.textContent = '(pattern not available)';
          }
        }

        function renderProviders(dataSet) {
          const providerBody = document.querySelector('#providers-table tbody');
          if (!providerBody) return;
          providerBody.innerHTML = '';
          const providers = safeArray(dataSet.providers);
          if (providers.length) {
            providers.forEach((p) => {
              const tr = document.createElement('tr');
              tr.innerHTML = `<td>${p.provider}</td><td>${fmtMoney(p.cost)}</td><td>${fmtPct(p.pctOfTotal)}</td><td>${p.rows}</td>`;
              providerBody.appendChild(tr);
            });
          } else {
            providerBody.innerHTML = '<tr><td colspan="4" class="muted">(none)</td></tr>';
          }
        }

        function renderPlatformsTable(dataSet) {
          const platTbody = document.querySelector('#platforms-table tbody');
          if (!platTbody) return;
          platTbody.innerHTML = '';
          const platforms = safeArray(dataSet.platforms);
          if (!platforms.length) {
            platTbody.innerHTML = '<tr><td colspan="4" class="muted">(none)</td></tr>';
            return;
          }
          platforms.forEach(p => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${p.platform}</td><td>${fmtMoney(p.cost)}</td><td>${fmtPct(p.pctOfTotal)}</td><td>${p.rows}</td>`;
            platTbody.appendChild(tr);
          });
        }

        function renderCooccurrence(dataSet) {
          const coWrap = document.getElementById('co-table');
          if (!coWrap) return;
          coWrap.innerHTML = '';
          const pairs = safeArray(dataSet.coOccurrence).slice(0, 8);
          if (!pairs.length) {
            coWrap.textContent = '(none)';
            return;
          }
          pairs.forEach(pair => {
            const row = document.createElement('div');
            row.className = 'row';
            row.style.marginBottom = '8px';
            row.innerHTML = `<div>${pair.pair[0]} + ${pair.pair[1]}</div><div class="tag">${pair.products} products</div>`;
            coWrap.appendChild(row);
          });
        }

        function renderStackCards(dataSet) {
          const stacks = document.getElementById('stack-cards');
          if (!stacks) return;
          stacks.innerHTML = '';
          const products = safeArray(dataSet.products);
          if (!products.length) {
            stacks.textContent = '(none)';
            return;
          }
          products.forEach(p => {
            const sCard = document.createElement('div');
            sCard.className = 'stack-card';
            sCard.innerHTML = `<div class="row"><div><strong>${p.product}</strong><div class="muted">${fmtMoney(p.cost)} / ${fmtPct(p.pctOfTotal)} of total</div></div><div class="tag">HHI ${p.hhi}</div></div>`;
            const list = document.createElement('div');
            list.style.marginTop = '10px';
            (p.services || []).forEach(svc => {
              const line = document.createElement('div');
              line.className = 'row';
              line.style.marginBottom = '6px';
              line.innerHTML = `<div class="muted">${svc.service}</div><div>${fmtPct(svc.pctOfProduct)}</div>`;
              list.appendChild(line);
            });
            sCard.appendChild(list);
            stacks.appendChild(sCard);
          });
        }

        function renderSharedStacks(dataSet) {
          const shared = document.getElementById('shared-stacks');
          if (!shared) return;
          shared.innerHTML = '';
          const stacks = safeArray(dataSet.sharedStacks);
          if (!stacks.length) {
            shared.textContent = '(none)';
            return;
          }
          stacks.forEach(stack => {
            const wrap = document.createElement('div');
            wrap.className = 'stack-card';
            wrap.innerHTML = `<div><strong>${stack.products.join(', ')}</strong></div>`;
            const chips = document.createElement('div');
            chips.className = 'chips';
            stack.services.forEach(s => {
              const c = document.createElement('div');
              c.className = 'chip';
              c.textContent = s;
              chips.appendChild(c);
            });
            wrap.appendChild(chips);
            shared.appendChild(wrap);
          });
        }

        // Tabs
        document.querySelectorAll('.tab').forEach(tab => {
          tab.addEventListener('click', () => {
            const target = tab.getAttribute('data-tab');
            document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t === tab));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.toggle('active', c.id === target));
          });
        });

        // Filter helpers
        function setPlatformOptions(sel) {
          sel.innerHTML = '';
          const allOpt = document.createElement('option'); allOpt.value='all'; allOpt.textContent='All platforms'; sel.appendChild(allOpt);
          safeArray(activeData.platforms).forEach(p => { const opt=document.createElement('option'); opt.value=p.platform; opt.textContent=p.platform; sel.appendChild(opt); });
        }
        function setProductOptions(sel, platform) {
          sel.innerHTML = '';
          const allOpt = document.createElement('option'); allOpt.value='all'; allOpt.textContent='All products'; sel.appendChild(allOpt);
          if (platform === 'all') return;
          const p = safeArray(activeData.platforms).find(x => x.platform === platform);
          if (!p) return;
          safeArray(p.products).forEach(pr => { const opt=document.createElement('option'); opt.value=pr.product; opt.textContent=pr.product; sel.appendChild(opt); });
        }

        // FinOps filters
        const finPlatSel = document.getElementById('finops-platform-filter');
        const finProdSel = document.getElementById('finops-product-filter');
        const anPlatSel = document.getElementById('anomaly-platform-filter');
        const anProdSel = document.getElementById('anomaly-product-filter');

        function getScope(platform, product) {
          if (!activeData) return null;
          const products = safeArray(activeData.products);
          const services = safeArray(activeData.services);
          const environments = safeArray(activeData.environments);
          if (platform === 'all') {
            return {
              cost: activeData.totalCost || 0,
              products: products.map(p => ({name: p.product, cost: p.cost, pct: p.pctOfTotal})),
              services: services.map(s => ({name: s.service, cost: s.cost, pct: s.pctOfTotal})),
              envs: environments.map(e => ({name: e.environment, cost: e.cost, pct: e.pctOfTotal})),
              storageShare: services.filter(s => ['AmazonEBS','AmazonS3','Block Storage','Object Storage'].includes(s.service)).reduce((a,b)=>a+b.pctOfTotal,0),
              meta: `${products.length} tagged products / ${services.length} services`,
            };
          }
          const plat = safeArray(activeData.platforms).find(p => p.platform === platform);
          if (!plat) return null;
          if (product === 'all') {
            return {
              cost: plat.cost,
              products: safeArray(plat.products).map(p => ({name: p.product, cost: p.cost, pct: p.pctOfPlatform})),
              services: safeArray(plat.services).map(s => ({name: s.service, cost: s.cost, pct: s.pctOfPlatform})),
              envs: safeArray(plat.environments).map(e => ({name: e.environment, cost: e.cost, pct: e.pctOfPlatform})),
              storageShare: safeArray(plat.services).filter(s => ['AmazonEBS','AmazonS3','Block Storage','Object Storage'].includes(s.service)).reduce((a,b)=>a+b.pctOfPlatform,0),
              meta: `${safeArray(plat.products).length} products / ${safeArray(plat.services).length} services`,
            };
          }
          const prodObj = safeArray(plat.products).find(p => p.product === product);
          if (!prodObj) return null;
          return {
            cost: prodObj.cost,
            products: [{name: prodObj.product, cost: prodObj.cost, pct: prodObj.pctOfPlatform}],
            services: safeArray(prodObj.services).map(s => ({name: s.service, cost: s.cost, pct: s.pctOfPlatform})),
            envs: safeArray(prodObj.environments).map(e => ({name: e.environment, cost: e.cost, pct: e.pctOfPlatform})),
            storageShare: safeArray(prodObj.services).filter(s => ['AmazonEBS','AmazonS3','Block Storage','Object Storage'].includes(s.service)).reduce((a,b)=>a+b.pctOfPlatform,0),
            meta: `${prodObj.product} / ${fmtPct(prodObj.pctOfPlatform)} of ${platform}`,
          };
        }

        function renderFinops(platform, product) {
          const scope = getScope(platform, product);
          if (!scope) return;
          document.getElementById('total-cost').textContent = fmtMoney(scope.cost);
          document.getElementById('product-count').textContent = scope.meta;
          renderBars(scope.products.map(p => ({name:p.name, cost:fmtMoney(p.cost), pct:p.pct})), document.querySelector('#products-table tbody'));
          renderBars(scope.services.map(s => ({name:s.name, cost:fmtMoney(s.cost), pct:s.pct})), document.querySelector('#services-table tbody'));
          renderBars(scope.envs.map(e => ({name:e.name, cost:fmtMoney(e.cost), pct:e.pct})), document.querySelector('#env-table tbody'));
          document.getElementById('storage-share').textContent = fmtPct(scope.storageShare || 0);
          document.getElementById('env-split').textContent = scope.envs.map(e => `${e.name}:${fmtPct(e.pct)}`).join(' / ');
        }

        finPlatSel.addEventListener('change', (e)=>{
          setProductOptions(finProdSel, e.target.value);
          finProdSel.value = 'all';
          renderFinops(e.target.value, 'all');
        });
        finProdSel.addEventListener('change', ()=>renderFinops(finPlatSel.value, finProdSel.value));

        // Naming/platform filters
        const platSel = document.getElementById('platform-filter');
        const prodSel = document.getElementById('naming-product-filter');

        function renderNaming(platform, product) {
          const resTbody = document.querySelector('#resnames-table tbody');
          const platMeta = document.getElementById('platform-meta');
          const platCost = document.getElementById('plat-cost');
          const platVcpu = document.getElementById('plat-vcpu');
          const platRam = document.getElementById('plat-ram');
          const platEbs = document.getElementById('plat-ebs');
          const platS3 = document.getElementById('plat-s3');
          const platNics = document.getElementById('plat-nics');
          const ec2Tbody = document.querySelector('#ec2-table tbody');
          resTbody.innerHTML = '';
          ec2Tbody.innerHTML = '';

          if (platform === 'all') {
            let vcpuSum=0, ramSum=0, ebsSum=0, s3Sum=0, nicsSum=0;
            const skuAgg = {};
            safeArray(activeData.platforms).forEach(p => {
              vcpuSum += p.vcpuTotal || 0;
              ramSum  += p.ramGiBTotal || 0;
              ebsSum  += p.ebsGbMo || 0;
              s3Sum   += p.s3GbMo || 0;
              nicsSum += p.nicCount || 0;
              safeArray(p.ec2Skus).forEach(s => {
                if (!skuAgg[s.sku]) skuAgg[s.sku] = { sku:s.sku, vcpu:s.vcpu, ramGiB:s.ramGiB, hours:0, instances:0 };
                skuAgg[s.sku].hours += s.hours || 0;
                skuAgg[s.sku].instances += s.instances || 0;
              });
            });
            platMeta.textContent = 'All platforms';
            platCost.textContent = fmtMoney(activeData.totalCost || 0);
            platVcpu.textContent = vcpuSum;
            platRam.textContent = ramSum.toFixed(2);
            platEbs.textContent = ebsSum.toFixed(2);
            platS3.textContent = s3Sum.toFixed(2);
            platNics.textContent = nicsSum;
            safeArray(activeData.resourceNames).forEach(r => {
              const tr = document.createElement('tr');
              tr.innerHTML = `<td>${r.name}</td><td>${fmtMoney(r.cost)}</td><td>${fmtPct(r.pctOfTotal)}</td><td>${r.rows}</td>`;
              resTbody.appendChild(tr);
            });
            Object.values(skuAgg).sort((a,b)=>b.hours-a.hours).forEach(s => {
              const tr = document.createElement('tr');
              tr.innerHTML = `<td>${s.sku}</td><td>${s.vcpu}</td><td>${s.ramGiB}</td><td>${s.hours.toFixed(2)}</td><td>${s.instances}</td>`;
              ec2Tbody.appendChild(tr);
            });
            return;
          }
          const plat = safeArray(activeData.platforms).find(p => p.platform === platform);
          if (!plat) return;

          let scope = {
            cost: plat.cost, vcpu: plat.vcpuTotal, ram: plat.ramGiBTotal,
            ebs: plat.ebsGbMo, s3: plat.s3GbMo, nics: plat.nicCount,
            resnames: plat.resourceNames, ec2: plat.ec2Skus,
            meta: `${platform} / ${fmtPct(plat.pctOfTotal)} of total / rows ${plat.rows}`
          };
          if (product !== 'all') {
            const pr = safeArray(plat.products).find(p => p.product === product);
            if (pr) {
              scope = {
                cost: pr.cost, vcpu: pr.vcpuTotal, ram: pr.ramGiBTotal,
                ebs: pr.ebsGbMo, s3: pr.s3GbMo, nics: pr.nicCount,
                resnames: pr.resourceNames, ec2: pr.ec2Skus,
                meta: `${platform}/${product} / ${fmtPct(pr.pctOfPlatform)} of platform / rows ${pr.rows}`
              };
            }
          }

          platMeta.textContent = scope.meta;
          platCost.textContent = fmtMoney(scope.cost);
          platVcpu.textContent = scope.vcpu;
          platRam.textContent = scope.ram;
          platEbs.textContent = scope.ebs;
          platS3.textContent = scope.s3;
          platNics.textContent = scope.nics;

          safeArray(scope.resnames).forEach(r => {
            const pct = r.pctOfPlatform ?? r.pctOfTotal ?? 0;
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${r.name}</td><td>${fmtMoney(r.cost)}</td><td>${fmtPct(pct)}</td><td>${r.rows}</td>`;
            resTbody.appendChild(tr);
          });
          safeArray(scope.ec2).forEach(s => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${s.sku}</td><td>${s.vcpu}</td><td>${s.ramGiB}</td><td>${s.hours}</td><td>${s.instances}</td>`;
            ec2Tbody.appendChild(tr);
          });
        }

        platSel.addEventListener('change', (e)=>{ setProductOptions(prodSel, e.target.value); prodSel.value='all'; renderNaming(e.target.value, 'all'); });
        prodSel.addEventListener('change', ()=>renderNaming(platSel.value, prodSel.value));

        function renderAnomaly(platform, product) {
          const ec2Body = document.querySelector('#anomaly-ec2-table tbody');
          const ebsBody = document.querySelector('#anomaly-ebs-table tbody');
          const s3Body = document.querySelector('#anomaly-s3-table tbody');
          ec2Body.innerHTML = '';
          ebsBody.innerHTML = '';
          s3Body.innerHTML = '';
          const ec2Chart = document.getElementById('anomaly-ec2-chart');
          const ebsChart = document.getElementById('anomaly-ebs-chart');
          const s3Chart = document.getElementById('anomaly-s3-chart');

          const aggBuckets = (plats, key) => {
            const acc = {};
            plats.forEach(p => {
              (p[key] || []).forEach(b => {
                acc[b.label] = acc[b.label] || { label: b.label, gbMo: 0, resources: 0 };
                acc[b.label].gbMo += b.gbMo || 0;
                acc[b.label].resources += b.resources || 0;
              });
            });
            return Object.values(acc).sort((a,b)=>a.label.localeCompare(b.label));
          };

          const aggSkus = (plats) => {
            const acc = {};
            plats.forEach(p => {
              (p.vmSkus || []).forEach(s => {
                const k = s.sku;
                if (!acc[k]) acc[k] = { sku:k, vcpu:s.vcpu, ramGiB:s.ramGiB, hours:0, instances:0 };
                acc[k].hours += s.hours || 0;
                acc[k].instances += s.instances || 0;
              });
            });
            return Object.values(acc).sort((a,b)=>b.hours - a.hours);
          };

          let plats = safeArray(activeData.platforms);
          if (platform !== 'all') {
            const p = safeArray(activeData.platforms).find(x => x.platform === platform);
            if (!p) return;
            if (product !== 'all') {
              const pr = safeArray(p.products).find(pp => pp.product === product);
              if (!pr) return;
              plats = [{ ...pr, vmSkus: pr.vmSkus, blockBuckets: pr.blockBuckets, objectBuckets: pr.objectBuckets }];
            } else {
              plats = [p];
            }
          }

          aggSkus(plats).forEach(s => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${s.sku}</td><td>${s.vcpu}</td><td>${s.ramGiB}</td><td>${s.hours.toFixed(2)}</td><td>${s.instances}</td>`;
            ec2Body.appendChild(tr);
          });
          const blockBuckets = aggBuckets(plats, 'blockBuckets').sort((a,b)=>bucketOrder.indexOf(a.label) - bucketOrder.indexOf(b.label));
          const objectBuckets = aggBuckets(plats, 'objectBuckets').sort((a,b)=>bucketOrder.indexOf(a.label) - bucketOrder.indexOf(b.label));
          blockBuckets.forEach(b => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${b.label}</td><td>${b.gbMo.toFixed(2)}</td><td>${b.resources}</td>`;
            ebsBody.appendChild(tr);
          });
          objectBuckets.forEach(b => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${b.label}</td><td>${b.gbMo.toFixed(2)}</td><td>${b.resources}</td>`;
            s3Body.appendChild(tr);
          });

          // Charts
          const vmSkus = aggSkus(plats);
          if (window.Plotly) {
            const baseLayout = {
              paper_bgcolor: 'rgba(0,0,0,0)',
              plot_bgcolor: 'rgba(8, 12, 24, 0.55)',
              font: {color: '#dbe7ff', family: 'DM Sans, sans-serif', size: 12},
              margin: {t: 26, l: 50, r: 20, b: 56},
              height: 320,
              xaxis: {
                gridcolor: 'rgba(148, 163, 184, 0.12)',
                tickangle: -22,
                tickfont: {size: 11},
                linecolor: 'rgba(148, 163, 184, 0.2)',
                zerolinecolor: 'rgba(148, 163, 184, 0.12)',
                automargin: true
              },
              yaxis: {
                gridcolor: 'rgba(148, 163, 184, 0.12)',
                tickfont: {size: 11},
                zerolinecolor: 'rgba(148, 163, 184, 0.12)',
                automargin: true
              },
              hoverlabel: {
                bgcolor: 'rgba(15, 23, 42, 0.96)',
                bordercolor: 'rgba(148, 163, 184, 0.4)',
                font: {color: '#e8edf8'}
              },
              bargap: 0.35,
              showlegend: false
            };

            Plotly.newPlot(ec2Chart, [{
              type: 'bar',
              x: vmSkus.map(s => s.sku),
              y: vmSkus.map(s => s.hours),
              text: vmSkus.map(s => `vCPU ${s.vcpu || '-'} / RAM ${s.ramGiB || '-'} GiB / Instances ${s.instances}`),
              hovertemplate: '%{x}<br>Hours %{y:.2f}<br>%{text}<extra></extra>',
              marker: {
                color: chartPalette.vm,
                line: {color: 'rgba(255,255,255,0.25)', width: 1},
                opacity: 0.9
              }
            }], {
              ...baseLayout,
              margin: {t: 10, l: 45, r: 20, b: 40},
              height: 260,
              title: '',
              yaxis: {...baseLayout.yaxis, title: 'Hours'},
              xaxis: {...baseLayout.xaxis, title: 'Size'}
            }, {displayModeBar: false});

            Plotly.newPlot(ebsChart, [{
              type: 'bar',
              x: blockBuckets.map(b => b.label),
              y: blockBuckets.map(b => b.gbMo),
              text: blockBuckets.map(b => `${b.resources} resources`),
              hovertemplate: '%{x}<br>GB %{y:.2f}<br>%{text}<extra></extra>',
              marker: {
                color: chartPalette.block,
                line: {color: 'rgba(255,255,255,0.2)', width: 1},
                opacity: 0.9
              }
            }], {
              ...baseLayout,
              margin: {t: 10, l: 45, r: 20, b: 40},
              height: 240,
              title: '',
              yaxis: {...baseLayout.yaxis, title: 'GB'},
              xaxis: {...baseLayout.xaxis, title: 'Bucket'}
            }, {displayModeBar: false});

            Plotly.newPlot(s3Chart, [{
              type: 'bar',
              x: objectBuckets.map(b => b.label),
              y: objectBuckets.map(b => b.gbMo),
              text: objectBuckets.map(b => `${b.resources} buckets`),
              hovertemplate: '%{x}<br>GB %{y:.2f}<br>%{text}<extra></extra>',
              marker: {
                color: chartPalette.object,
                line: {color: 'rgba(255,255,255,0.2)', width: 1},
                opacity: 0.9
              }
            }], {
              ...baseLayout,
              margin: {t: 10, l: 45, r: 20, b: 40},
              height: 240,
              title: '',
              yaxis: {...baseLayout.yaxis, title: 'GB'},
              xaxis: {...baseLayout.xaxis, title: 'Bucket'}
            }, {displayModeBar: false});
          }
        }

        anPlatSel.addEventListener('change', (e)=>{ setProductOptions(anProdSel, e.target.value); anProdSel.value='all'; renderAnomaly(e.target.value, 'all'); });
        anProdSel.addEventListener('change', ()=>renderAnomaly(anPlatSel.value, anProdSel.value));

        function refreshAll() {
          setPlatformOptions(finPlatSel);
          setProductOptions(finProdSel, 'all');
          setPlatformOptions(anPlatSel);
          setProductOptions(anProdSel, 'all');
          setPlatformOptions(platSel);
          setProductOptions(prodSel, 'all');
          finPlatSel.value = 'all';
          finProdSel.value = 'all';
          anPlatSel.value = 'all';
          anProdSel.value = 'all';
          platSel.value = 'all';
          prodSel.value = 'all';
          renderFinops('all','all');
          renderNaming('all','all');
          renderAnomaly('all','all');
          renderPlatformsTable(activeData);
          renderCooccurrence(activeData);
          renderStackCards(activeData);
          renderSharedStacks(activeData);
          renderProviders(activeData);
          renderNamingMeta();
          updateSourceInfo();
        }

        if (reportSelect) {
          reportSelect.innerHTML = '';
          reportViews.forEach((report) => {
            const opt = document.createElement('option');
            opt.value = report.id;
            opt.textContent = report.label;
            reportSelect.appendChild(opt);
          });
          reportSelect.value = activeReport.id;
          reportSelect.addEventListener('change', (e) => {
            const next = reportViews.find(r => r.id === e.target.value);
            if (!next) return;
            activeReport = next;
            activeData = next.data;
            refreshAll();
          });
          if (reportViews.length <= 1 && reportCard) {
            reportCard.style.display = 'none';
          }
        }

        refreshAll();
      }).catch(err => {
        document.body.innerHTML = '<div style="padding:24px;color:#fff;font-family:monospace;">Failed to load report_data.json. Run `python cur_to_json.py` first.<br/><br/>' + err + '</div>';
      });
    }

    render();
  </script>
</body>
</html>
